# Prepare the environment

```
#!/bin/bash/

# Install osquery prerequisites
sudo apt install --no-install-recommends git python3 bison flex make

# Optional, python tools for testing
sudo apt install --no-install-recommends python3-pip python3-setuptools python3-psutil python3-six python3-wheel
pip3 install timeout_decorator thrift==0.11.0 osquery pexpect==3.3

# Optional, RPM packaging
sudo apt install --no-install-recommends rpm binutils

# Toolchain
export ARCH=$(uname -m)
wget https://github.com/osquery/osquery-toolchain/releases/download/1.1.0/osquery-toolchain-1.1.0-${ARCH}.tar.xz
sudo tar xvf osquery-toolchain-1.1.0-${ARCH}.tar.xz -C /usr/local
wget https://cmake.org/files/v3.21/cmake-3.21.4-linux-${ARCH}.tar.gz
sudo tar xvf cmake-3.21.4-linux-${ARCH}.tar.gz -C /usr/local --strip 1

# Clone osquery source code
git clone https://github.com/osquery/osquery osquery

# Download the extension
git clone https://github.com/dabresua/connect_extension connect_extension

# Symlink your external extension source code directory into external
# Use extension_ for the symlink
# Use absolute path
cd connect_extension
CONNECT_EXTENSION=$(pwd)
cd ../osquery
ln -s $CONNECT_EXTENSION external/extension_connect

# Configure osquery project
mkdir build
cd build
cmake -DOSQUERY_TOOLCHAIN_SYSROOT=/usr/local/osquery-toolchain ..
```

# How to build the extension

The extensions developed in C++ must be built against the osquery core given that they need to be linked with the SDK and the headers of osquery used.

Simple extensions with only one source file can be built using the command
```
make externals -j$(nproc)
```

However, this extension has more files, so a CMakeLists.txt is required and the way to build it is different

```
# Enter the extension build folder (we are currently in osquery/build)
cd external/extension_connect

# The Makefile has been generated by the configure phase, so we now can build
make -j(nproc)
```

# How to build coverage reports for the extension

After building the extension, the steps required to show the coverage reports are the following.

| ⚠ It is mandatory to use the programs the osquery's toolchain provides. Otherwise, the commands won't work.

Run the tests

```bash
./connect_extension_test
```

A file with the name of `default.profraw` is created. This file includes raw data for the coverage report.
Raw profiles have to be indexed before they can be used to generate coverage reports. This is done using the “merge” tool in llvm-profdata (which can combine multiple raw profiles and index them at the same time):

```bash
/usr/local/osquery-toolchain/usr/bin/llvm-profdata merge -sparse default.profraw -o default.profdata
```

Which creates `default.profdata`.

To show the report use the next command. Note that we are filtering osquery core and libraries.

```bash
/usr/local/osquery-toolchain/usr/bin/llvm-cov report ./connect_extension_test -instr-profile=default.profdata --ignore-filename-regex="ns_osquery*|libraries"
```

Report example:

```bash
lename                      Regions    Missed Regions     Cover   Functions  Missed Functions  Executed       Lines      Missed Lines     Cover
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table/connect.cpp                  77                54    29.87%           7                 3    57.14%         207               134    35.27%
tests/connect.cpp                  12                 1    91.67%           5                 1    80.00%          29                 1    96.55%
tests/main.cpp                      1                 0   100.00%           1                 0   100.00%          13                 0   100.00%
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
TOTAL                              90                55    38.89%          13                 4    69.23%         249               135    45.78%
```

For a line-by-line report, use the `show` command:

```bash
/usr/local/osquery-toolchain/usr/bin/llvm-cov show ./connect_extension_test -instr-profile=default.profdata --ignore-filename-regex="ns_osquery*|libraries"
```

# Run and debug using the interactive shell

This method is suited for running the extension in a different terminal with gdb, if you don't need that, you can simply use:

```
osqueryi --extension /path/to/your_extension.ext
```

The extension needs to connect with the osquery's core using a socket.

```
osqueryi --extensions_socket ~/.osquery/shell.em
```

In the osquery interactive shell try to query the table
```
select * from connect where server_ip="8.8.8.8" and server_port=80;
```

It returns an error: `Error: no such table: connect`

In the first terminal `osquery/build/external/extension_connect`, launch the extension. We can run it with gdb for debugging purposes.
We must run it with root permissions because the core have been launched using sudo.

```
gdb --args connect_extension.ext --socket ~/.osquery/shell.em
```

Return to the osquery interactive shell and try to query the table again
```
select * from connect where server_ip="8.8.8.8" and server_port=80;
```

This time, the query returns something like this:
```
+--------------+-----------+-------------+-----------+-----------+
| my_ip        | server_ip | server_port | reachable | trip_time |
+--------------+-----------+-------------+-----------+-----------+
| 192.168.0.16 | 8.8.8.8   | 53          | 1         | 14        |
+--------------+-----------+-------------+-----------+-----------+
```

Another example:

```
osquery> select * from connect where server_name="google.com" and server_port="80";
+--------------+-------------+-----------------+-------------+-----------+-----------+
| my_ip        | server_name | server_ip       | server_port | reachable | trip_time |
+--------------+-------------+-----------------+-------------+-----------+-----------+
| 192.168.0.16 | google.com  | 142.250.200.142 | 80          | 1         | 8         |
+--------------+-------------+-----------------+-------------+-----------+-----------+
```

# Run and debug using the daemon

Usually, the extension will be deploy during the installation of osquery and the `osquery.flags` file will be configured accordingly to launch the extension from the core automatically. Testing this, it's a little bit tricky.

There are [different ways to do it](https://osquery.readthedocs.io/en/stable/deployment/extensions/), I'm explaining what I'm use to do.

First, we need to stop the osquery daemon process

```
sudo systemctl stop osqueryd
```

Then, launch the osquery daemon in verbose mode with the extension

```
sudo osqueryd --flagfile /etc/osquery/osquery.flags --extension=~/osquery/build/external/extension_connect/connect_extension.ext --verbose
```

On a different terminal, start the osquery interactive shell

```
osqueryi
```
Then, you can query the table. Note that the standard output of the extension is printed in the shell

```
osquery> select * from connect where server_name="osquery.io" and server_port="80";
+--------------+-------------+---------------+-------------+-----------+--------------+
| my_ip        | server_name | server_ip     | server_port | reachable | connect_time |
+--------------+-------------+---------------+-------------+-----------+--------------+
| 192.168.0.16 | osquery.io  | 108.157.98.69 | 80          | 1         | 13           |
| 192.168.0.16 | osquery.io  | 108.157.98.50 | 80          | 1         | 3            |
| 192.168.0.16 | osquery.io  | 108.157.98.40 | 80          | 1         | 3            |
| 192.168.0.16 | osquery.io  | 108.157.98.82 | 80          | 1         | 2            |
+--------------+-------------+---------------+-------------+-----------+--------------+
```